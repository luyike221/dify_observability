# 从旧脚本迁移到新架构指南

## 概述

原有的 `fetch_workflow_logs.py` 脚本已重构为基于 Prefect 的工程化架构。本文档说明如何从旧脚本迁移到新系统。

## 主要变化

### 1. 架构变化

**旧架构**：
- 单体脚本（1300+ 行）
- 命令行参数驱动
- 直接执行

**新架构**：
- 模块化设计（多个服务模块）
- Prefect Flow 编排
- 配置管理（环境变量 + 配置文件）
- 任务调度和监控

### 2. 功能保留

✅ **所有原有功能均已保留**：
- 日志获取（支持所有过滤条件）
- 详细信息获取
- CSV/Markdown/JSON 报告生成
- 命令行接口（向后兼容）

### 3. 新增功能

✨ **新增功能**：
- Prefect 任务调度
- 可视化监控（Prefect UI）
- 结构化日志
- 通知机制
- 存储服务抽象
- 重试机制

## 迁移步骤

### 步骤 1: 安装依赖

```bash
cd 01-dify运维监控
pip install -r requirements.txt
```

### 步骤 2: 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，填写你的配置
# 至少需要配置：
# - DIFY_BASE_URL
# - DIFY_API_TOKEN
# - DIFY_APP_ID
```

### 步骤 3: 启动 Prefect Server

```bash
# 开发环境
prefect server start

# 或使用 Docker Compose（生产环境）
# 参考 Prefect 官方文档
```

### 步骤 4: 设置 Prefect 环境

```bash
./scripts/setup_prefect.sh
```

### 步骤 5: 启动 Worker

```bash
prefect worker start --pool dify-workflow-pool
```

### 步骤 6: 部署任务（可选）

```bash
# 部署每日报告任务
python deployments/daily_report.py

# 部署每周报告任务
python deployments/weekly_report.py
```

## 使用方式对比

### 旧方式（仍然支持）

```bash
python fetch_workflow_logs.py \
  --api-token app-xxx \
  --base-url http://localhost \
  --with-details \
  --with-node-executions \
  --console-email your@email.com \
  --console-password your-password \
  --app-id your-app-id \
  --output-csv-dir ./outputs
```

### 新方式 1: Prefect Flow（推荐）

```python
from src.flows.workflow_log_flow import fetch_workflow_logs_flow

# 在 Python 代码中调用
result = fetch_workflow_logs_flow(
    created_at_after="2024-01-01T00:00:00Z",
    created_at_before="2024-01-31T23:59:59Z",
    output_format="csv",
    with_details=True,
    with_node_executions=True,
    output_dir="./outputs/reports",
)
```

### 新方式 2: Prefect UI

1. 访问 http://localhost:4200
2. 找到部署的任务（如 `daily-workflow-report`）
3. 点击 "Run" 按钮
4. 可以覆盖参数
5. 查看执行状态和日志

### 新方式 3: Prefect CLI

```bash
# 运行部署的任务
prefect deployment run fetch-workflow-logs/daily-workflow-report

# 带参数运行
prefect deployment run fetch-workflow-logs/daily-workflow-report \
  --param created_at_after="2024-01-01T00:00:00Z"
```

## 参数映射

### 命令行参数 → Flow 参数

| 旧参数 | 新参数 | 说明 |
|--------|--------|------|
| `--api-token` | `api_token` (环境变量) | 应用 API Token |
| `--base-url` | `base_url` (环境变量) | Dify API 基础 URL |
| `--app-id` | `app_id` (环境变量) | 应用 ID |
| `--keyword` | `keyword` | 搜索关键词 |
| `--status` | `status` | 执行状态 |
| `--before` | `created_at_before` | 创建时间上限 |
| `--after` | `created_at_after` | 创建时间下限 |
| `--with-details` | `with_details` | 获取详细信息 |
| `--with-node-executions` | `with_node_executions` | 包含节点执行详情 |
| `--output-csv-dir` | `output_dir` | 输出目录 |
| `--fetch-all` | `fetch_all` | 获取所有日志 |
| `--limit` | `limit` | 每页数量 |
| `--max-pages` | `max_pages` | 最大页数限制 |

### 环境变量配置

大部分配置现在可以通过环境变量设置，无需每次传递参数：

```bash
# .env 文件
DIFY_BASE_URL=http://localhost
DIFY_API_TOKEN=app-xxx
DIFY_APP_ID=your-app-id
DIFY_CONSOLE_EMAIL=your@email.com
DIFY_CONSOLE_PASSWORD=your-password
```

## 输出变化

### 输出目录结构

**旧结构**：
```
./outputs/
  ├── 问答类应用数-总览.csv
  ├── 问答类应用数-每日消息数.csv
  ├── 问答类应用数-用户列表.csv
  └── 问答类应用数-用户问答对.csv
```

**新结构**：
```
./outputs/
  ├── logs/                    # 日志文件
  │   ├── app_2024-01-01.log
  │   └── error_2024-01-01.log
  ├── reports/                 # 报告文件
  │   ├── daily/               # 每日报告
  │   │   └── 问答类应用数-*.csv
  │   └── weekly/              # 每周报告
  │       └── 问答类应用数-*.csv
  └── data/                    # 原始数据备份
      └── logs_data_*.json
```

## 常见问题

### Q1: 旧脚本还能用吗？

**A**: 可以！旧脚本 `fetch_workflow_logs.py` 仍然保留，完全向后兼容。

### Q2: 必须使用 Prefect 吗？

**A**: 不是必须的。你可以：
1. 继续使用旧脚本（命令行方式）
2. 直接调用 Flow 函数（不部署）
3. 使用 Prefect 进行调度和监控（推荐）

### Q3: 如何迁移现有的定时任务？

**A**: 
1. 如果使用 cron，可以继续使用，但建议迁移到 Prefect
2. 创建对应的 Deployment 配置
3. 使用 Prefect 的调度功能替代 cron

### Q4: 配置在哪里管理？

**A**: 
- **环境变量**（推荐）: `.env` 文件
- **Flow 参数**: Prefect UI 或 Deployment 配置
- **代码中**: 作为参数传入

### Q5: 如何查看执行日志？

**A**: 
- **Prefect UI**: http://localhost:4200
- **日志文件**: `outputs/logs/app_*.log`
- **错误日志**: `outputs/logs/error_*.log`

## 回滚方案

如果新系统出现问题，可以：

1. **临时回滚**: 直接使用旧脚本
   ```bash
   python fetch_workflow_logs.py [参数...]
   ```

2. **检查配置**: 确保环境变量配置正确

3. **查看日志**: 检查 `outputs/logs/` 目录下的日志文件

## 下一步

1. ✅ 完成迁移步骤 1-6
2. ✅ 测试新系统功能
3. ✅ 配置通知（可选）
4. ✅ 设置存储后端（可选，默认本地）
5. ✅ 监控任务执行

## 获取帮助

- 查看 `README.md` 了解详细使用说明
- 查看 `改造方案.md` 了解架构设计
- 查看 Prefect 官方文档: https://docs.prefect.io/
