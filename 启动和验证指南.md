# 项目启动和定时任务验证指南

本指南将帮助您完整启动项目并验证定时任务是否生效。

## 📋 前置检查

### 1. 检查环境变量配置

```bash
# 检查是否存在 .env 文件
cd /root/docker-soft/dify/01-dify运维监控
ls -la .env

# 如果不存在，从模板创建
cp .env.example .env
# 然后编辑 .env 文件，填写必要的配置
```

### 2. 确认依赖已安装

```bash
# 使用 uv 同步依赖
uv sync
```

## 🚀 完整启动流程

### 步骤 1: 启动 Prefect Server

在**第一个终端窗口**运行：

```bash
cd /root/docker-soft/dify/01-dify运维监控
uv run prefect server start
```

等待看到以下输出表示启动成功：
```
View the API reference documentation at http://127.0.0.1:4200/docs
Check out the dashboard at http://127.0.0.1:4200
```

**保持此终端窗口运行！**

### 步骤 2: 配置 Prefect API URL

在**新的终端窗口**运行：

```bash
cd /root/docker-soft/dify/01-dify运维监控
uv run prefect config set PREFECT_API_URL=http://127.0.0.1:4200/api
```

### 步骤 3: 创建 Work Pool

```bash
# 检查 Work Pool 是否存在
uv run prefect work-pool ls

# 如果不存在，创建 Work Pool
uv run prefect work-pool create dify-workflow-pool --type process
```

### 步骤 4: 启动 Worker

在**第二个终端窗口**运行（保持运行）：

```bash
cd /root/docker-soft/dify/01-dify运维监控
uv run prefect worker start --pool dify-workflow-pool
```

等待看到类似输出：
```
Worker started! Polling for runs...
```

**保持此终端窗口运行！**

### 步骤 5: 部署定时任务

在**第三个终端窗口**运行：

#### 部署每日报告（调试模式：每30秒执行一次）

```bash
cd /root/docker-soft/dify/01-dify运维监控
uv run python deployments/daily_report.py
```

**重要**：`serve()` 方法会持续运行并自动处理调度，需要保持此终端窗口打开。

部署成功后，您会看到类似输出：
```
Your flow 'fetch-workflow-logs' is being served and polling for scheduled runs!

To trigger a run for this flow, use the following command:
    $ prefect deployment run 'fetch-workflow-logs/daily-workflow-report-debug'
```

#### 部署每周报告（每周一 03:00 执行）

如果需要部署每周报告，可以在**第四个终端窗口**运行：

```bash
cd /root/docker-soft/dify/01-dify运维监控
uv run python deployments/weekly_report.py
```

**注意**：每个 `serve()` 调用都需要一个独立的终端窗口保持运行。

## ✅ 验证定时任务是否生效

### 方法 1: 通过 Prefect UI 验证（推荐）

1. **打开浏览器访问 Prefect Dashboard**
   ```
   http://127.0.0.1:4200
   ```

2. **查看 Deployments**
   - 在左侧菜单点击 "Deployments"
   - 您应该能看到：
     - `daily-workflow-report-debug` (每30秒执行一次)
     - `weekly-workflow-report` (每周一 03:00 执行)

3. **查看 Schedule（调度）**
   - 点击任意 Deployment
   - 在详情页查看 "Schedule" 部分
   - 确认调度规则已正确设置

4. **查看 Flow Runs（执行记录）**
   - 在左侧菜单点击 "Flow Runs"
   - 等待30秒后，应该能看到新的运行记录
   - 点击运行记录查看详细日志和执行状态

5. **验证自动执行**
   - 观察 Flow Runs 列表
   - 每30秒应该自动出现新的运行记录（对于 daily-workflow-report-debug）
   - 检查运行状态是否为 "Completed" 或 "Running"

### 方法 2: 通过命令行验证

#### 查看所有 Deployments

```bash
uv run prefect deployment ls
```

#### 查看特定 Deployment 的详情

```bash
# 查看每日报告的部署详情
uv run prefect deployment inspect "fetch-workflow-logs-flow/daily-workflow-report-debug"

# 查看每周报告的部署详情
uv run prefect deployment inspect "fetch-workflow-logs-flow/weekly-workflow-report"
```

#### 查看 Flow Runs（执行记录）

```bash
# 查看最近的运行记录
uv run prefect flow-run ls --limit 10

# 查看特定 deployment 的运行记录
uv run prefect flow-run ls --deployment-name "fetch-workflow-logs-flow/daily-workflow-report-debug" --limit 10
```

#### 手动触发一次运行（测试）

```bash
# 手动触发每日报告
uv run prefect deployment run "fetch-workflow-logs-flow/daily-workflow-report-debug"

# 查看运行状态
uv run prefect flow-run ls --limit 1
```

### 方法 3: 检查输出文件

定时任务执行成功后，会生成报告文件：

```bash
# 查看每日报告输出
ls -lh outputs/reports/daily/

# 查看每周报告输出
ls -lh outputs/reports/weekly/

# 查看日志文件
ls -lh outputs/logs/
```

### 方法 4: 监控日志

#### 查看 Worker 日志

在运行 Worker 的终端窗口，您应该能看到：
- 任务被调度和执行的信息
- 执行状态和结果

#### 查看应用日志

```bash
# 查看最新的应用日志
tail -f outputs/logs/app_$(date +%Y-%m-%d).log

# 查看错误日志
tail -f outputs/logs/error_$(date +%Y-%m-%d).log
```

## 🔍 验证要点检查清单

- [ ] Prefect Server 正在运行（端口 4200）
- [ ] Prefect API URL 已正确配置
- [ ] Work Pool 已创建
- [ ] Worker 正在运行并连接到 Work Pool
- [ ] Deployment 已成功创建
- [ ] 在 Prefect UI 中能看到 Deployment 和 Schedule
- [ ] Flow Runs 列表中有新的执行记录
- [ ] 任务按预期时间间隔自动执行
- [ ] 输出文件已生成
- [ ] 日志文件中有执行记录

## 🐛 常见问题排查

### 问题 1: Prefect Server 无法连接

```bash
# 检查 Server 是否运行
curl http://127.0.0.1:4200/api/health

# 如果失败，重新启动 Server
uv run prefect server start
```

### 问题 2: Worker 无法启动

```bash
# 检查 Work Pool 是否存在
uv run prefect work-pool ls

# 如果不存在，创建它
uv run prefect work-pool create dify-workflow-pool --type process
```

### 问题 3: 任务没有自动执行

1. **检查 Schedule 是否启用**
   ```bash
   uv run prefect deployment inspect "fetch-workflow-logs-flow/daily-workflow-report-debug"
   ```
   查看输出中的 `schedule` 字段

2. **检查 Worker 是否在运行**
   - 确认 Worker 终端窗口没有错误
   - 确认 Worker 已连接到正确的 Work Pool

3. **在 UI 中检查**
   - 访问 http://127.0.0.1:4200
   - 查看 Deployment 的 Schedule 状态
   - 检查是否有错误信息

### 问题 4: 任务执行失败

1. **查看 Prefect UI 中的错误日志**
   - 点击失败的 Flow Run
   - 查看详细的错误信息

2. **检查环境变量**
   ```bash
   # 确认 .env 文件存在且配置正确
   cat .env
   ```

3. **查看应用日志**
   ```bash
   tail -50 outputs/logs/error_$(date +%Y-%m-%d).log
   ```

## 📊 预期行为

### 每日报告（调试模式）

- **执行频率**: 每30秒一次
- **时间范围**: 最近1小时的数据
- **输出位置**: `./outputs/reports/daily/`
- **验证方法**: 等待30秒后，在 Prefect UI 的 Flow Runs 中应该看到新的运行记录

### 每周报告

- **执行频率**: 每周一 03:00
- **时间范围**: 上周的数据
- **输出位置**: `./outputs/reports/weekly/`
- **验证方法**: 可以手动触发一次测试，或等待到周一 03:00

## 🎯 快速验证脚本

创建一个简单的验证脚本：

```bash
#!/bin/bash
# 快速验证脚本

echo "=== 检查 Prefect Server ==="
curl -s http://127.0.0.1:4200/api/health && echo "✅ Server 运行正常" || echo "❌ Server 未运行"

echo -e "\n=== 检查 Work Pool ==="
uv run prefect work-pool ls | grep dify-workflow-pool && echo "✅ Work Pool 存在" || echo "❌ Work Pool 不存在"

echo -e "\n=== 检查 Deployments ==="
uv run prefect deployment ls

echo -e "\n=== 检查最近的 Flow Runs ==="
uv run prefect flow-run ls --limit 5

echo -e "\n=== 检查输出文件 ==="
ls -lh outputs/reports/daily/ 2>/dev/null && echo "✅ 有输出文件" || echo "⚠️  暂无输出文件"
```

保存为 `scripts/verify.sh`，然后运行：

```bash
chmod +x scripts/verify.sh
./scripts/verify.sh
```

## 📝 总结

完成以上步骤后，您应该能够：

1. ✅ 成功启动 Prefect Server 和 Worker
2. ✅ 成功部署定时任务
3. ✅ 在 Prefect UI 中看到任务和调度
4. ✅ 验证任务按计划自动执行
5. ✅ 查看执行日志和输出文件

如果遇到任何问题，请参考"常见问题排查"部分，或查看 Prefect UI 中的详细错误信息。
