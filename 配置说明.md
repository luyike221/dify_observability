# ç¯å¢ƒå˜é‡é…ç½®è¯´æ˜

## ğŸ“‹ é…ç½®æ–¹å¼

### åº”ç”¨ç‰¹å®šé…ç½®ï¼ˆåœ¨éƒ¨ç½²æ–‡ä»¶ä¸­é…ç½®ï¼‰

**`api_token` å’Œ `app_id` æ˜¯åº”ç”¨ç‰¹å®šçš„ï¼Œæ¯ä¸ªåº”ç”¨ä¸åŒï¼Œåº”è¯¥åœ¨éƒ¨ç½²æ–‡ä»¶ä¸­ç›´æ¥é…ç½®**ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `.env` æ–‡ä»¶ã€‚

### é€šç”¨é…ç½®ï¼ˆä» .env æ–‡ä»¶è¯»å–ï¼‰

**`base_url` ç­‰é€šç”¨é…ç½®**å¯ä»¥ä» `.env` æ–‡ä»¶è¯»å–ã€‚

### 1. é…ç½®åº”ç”¨ç‰¹å®šå‚æ•°ï¼ˆåœ¨éƒ¨ç½²æ–‡ä»¶ä¸­ï¼‰

ç¼–è¾‘ `deployments/daily_report.py` æˆ– `deployments/weekly_report.py`ï¼Œåœ¨ `parameters` ä¸­é…ç½®ï¼š

```python
fetch_workflow_logs_flow.serve(
    name="daily-workflow-report-debug",
    parameters={
        # åº”ç”¨é…ç½®ï¼ˆæ¯ä¸ªåº”ç”¨ä¸åŒï¼Œå¿…é¡»åœ¨è¿™é‡Œé…ç½®ï¼‰
        "api_token": "app-xxxxxxxxxxxxx",  # æ›¿æ¢ä¸ºä½ çš„åº”ç”¨ API Token
        "app_id": "your-app-id",  # æ›¿æ¢ä¸ºä½ çš„åº”ç”¨ IDï¼ˆå¯é€‰ï¼‰
        
        # å…¶ä»–å‚æ•°...
    },
)
```

**é‡è¦**ï¼šæ¯ä¸ªåº”ç”¨çš„ `api_token` ä¸åŒï¼Œåº”è¯¥åœ¨éƒ¨ç½²æ–‡ä»¶ä¸­ç›´æ¥é…ç½®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `.env`ã€‚

### 2. é…ç½®é€šç”¨å‚æ•°ï¼ˆä» .env æ–‡ä»¶è¯»å–ï¼‰

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œç”¨äºé€šç”¨é…ç½®ï¼‰ï¼š

```bash
# ä»æ¨¡æ¿åˆ›å»º
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å†™é€šç”¨é…ç½®
vim .env
```

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®é€šç”¨å‚æ•°ï¼š

```bash
# Dify API åŸºç¡€ URLï¼ˆé€šç”¨é…ç½®ï¼‰
DIFY_BASE_URL=http://localhost

# Console API é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºè·å–èŠ‚ç‚¹æ‰§è¡Œè¯¦æƒ…ï¼‰
DIFY_CONSOLE_EMAIL=your-email@example.com
DIFY_CONSOLE_PASSWORD=your-password
DIFY_CONSOLE_TOKEN=
```

## ğŸ”„ é…ç½®ä¼˜å…ˆçº§

å®šæ—¶ä»»åŠ¡ä½¿ç”¨é…ç½®çš„ä¼˜å…ˆçº§ï¼š

1. **Flow å‚æ•°ï¼ˆéƒ¨ç½²æ–‡ä»¶ä¸­é…ç½®ï¼‰** - æœ€é«˜ä¼˜å…ˆçº§
2. **ç¯å¢ƒå˜é‡ï¼ˆ.env æ–‡ä»¶ï¼‰** - å¦‚æœå‚æ•°æœªæä¾›ï¼Œåˆ™ä½¿ç”¨ç¯å¢ƒå˜é‡

### å½“å‰å®ç°

åœ¨ `deployments/daily_report.py` å’Œ `deployments/weekly_report.py` ä¸­ï¼š

```python
fetch_workflow_logs_flow.serve(
    name="daily-workflow-report-debug",
    parameters={
        # åº”ç”¨ç‰¹å®šé…ç½®ï¼ˆå¿…é¡»åœ¨éƒ¨ç½²æ–‡ä»¶ä¸­é…ç½®ï¼‰
        "api_token": "app-xxxxxxxxxxxxx",  # æ¯ä¸ªåº”ç”¨ä¸åŒ
        "app_id": "your-app-id",
        
        # base_url å¦‚æœæ²¡æœ‰åœ¨è¿™é‡Œé…ç½®ï¼Œä¼šä» .env è¯»å–
        # "base_url": "http://localhost",  # å¯é€‰ï¼Œä¸é…ç½®åˆ™ä» .env è¯»å–
        
        # å…¶ä»–å‚æ•°...
    },
)
```

**å› æ­¤ï¼š**
- `api_token` å’Œ `app_id`ï¼š**å¿…é¡»åœ¨éƒ¨ç½²æ–‡ä»¶ä¸­é…ç½®**ï¼ˆæ¯ä¸ªåº”ç”¨ä¸åŒï¼‰
- `base_url`ï¼šå¯ä»¥ä» `.env` æ–‡ä»¶è¯»å–ï¼ˆé€šç”¨é…ç½®ï¼‰

## ğŸ“ é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹ 1: éƒ¨ç½²æ–‡ä»¶é…ç½®ï¼ˆåº”ç”¨ç‰¹å®šï¼‰

```python
# deployments/daily_report.py
fetch_workflow_logs_flow.serve(
    name="daily-workflow-report-debug",
    parameters={
        "api_token": "app-abc123xyz789",  # åº”ç”¨ A çš„ token
        "app_id": "5ac73990-ee17-4aba-993c-a473e2fa2a90",
        # ...
    },
)
```

### ç¤ºä¾‹ 2: .env æ–‡ä»¶é…ç½®ï¼ˆé€šç”¨é…ç½®ï¼‰

```bash
# .env
DIFY_BASE_URL=http://localhost:5001
DIFY_CONSOLE_EMAIL=admin@example.com
DIFY_CONSOLE_PASSWORD=your-password
```

### ç¤ºä¾‹ 3: å¤šä¸ªåº”ç”¨é…ç½®

å¦‚æœéœ€è¦ç›‘æ§å¤šä¸ªåº”ç”¨ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªéƒ¨ç½²æ–‡ä»¶ï¼š

```python
# deployments/daily_report_app1.py
fetch_workflow_logs_flow.serve(
    name="daily-report-app1",
    parameters={
        "api_token": "app-app1-token",
        "app_id": "app1-id",
        # ...
    },
)

# deployments/daily_report_app2.py
fetch_workflow_logs_flow.serve(
    name="daily-report-app2",
    parameters={
        "api_token": "app-app2-token",  # ä¸åŒçš„åº”ç”¨ï¼Œä¸åŒçš„ token
        "app_id": "app2-id",
        # ...
    },
)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¯ä¸ªåº”ç”¨çš„ `api_token` ä¸åŒ**
   - åœ¨ Dify æ§åˆ¶å°çš„"åº”ç”¨è®¾ç½®"ä¸­æŸ¥çœ‹å’Œå¤åˆ¶
   - æ ¼å¼é€šå¸¸æ˜¯ `app-` å¼€å¤´

2. **`.env` æ–‡ä»¶ä¸è¦æäº¤åˆ° Git**
   - `.env` æ–‡ä»¶é€šå¸¸å·²åœ¨ `.gitignore` ä¸­
   - åªæäº¤ `.env.example` ä½œä¸ºæ¨¡æ¿

3. **é…ç½®æ›´æ–°åéœ€è¦é‡å¯**
   - å¦‚æœä¿®æ”¹äº† `.env` æ–‡ä»¶
   - éœ€è¦é‡å¯å®šæ—¶ä»»åŠ¡ï¼ˆåœæ­¢å¹¶é‡æ–°è¿è¡Œ `deployments/*.py`ï¼‰

## ğŸ” éªŒè¯é…ç½®

### æ–¹æ³• 1: æ£€æŸ¥ç¯å¢ƒå˜é‡

```bash
# åœ¨é¡¹ç›®ç›®å½•ä¸‹
cd /root/docker-soft/dify/01-difyè¿ç»´ç›‘æ§
source .env 2>/dev/null || true
echo "DIFY_BASE_URL: $DIFY_BASE_URL"
echo "DIFY_API_TOKEN: ${DIFY_API_TOKEN:0:10}..."  # åªæ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦
```

### æ–¹æ³• 2: æŸ¥çœ‹æ—¥å¿—

è¿è¡Œå®šæ—¶ä»»åŠ¡åï¼ŒæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š

```bash
tail -f outputs/logs/app_$(date +%Y-%m-%d).log
```

å¦‚æœé…ç½®é”™è¯¯ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼é”™è¯¯ï¼š
```
ValueError: å¿…é¡»æä¾› base_url å’Œ api_tokenï¼ˆé€šè¿‡å‚æ•°æˆ–ç¯å¢ƒå˜é‡ï¼‰
```

### æ–¹æ³• 3: æµ‹è¯•é…ç½®

å¯ä»¥æ‰‹åŠ¨è¿è¡Œä¸€æ¬¡ Flow æ¥æµ‹è¯•é…ç½®ï¼š

```python
from src.flows.workflow_log_flow import fetch_workflow_logs_flow
from datetime import datetime, timedelta

# æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®
one_hour_ago = (datetime.now() - timedelta(hours=1)).strftime("%Y-%m-%dT%H:%M:%SZ")
now = datetime.now().strftime("%Y-%m-%dT%H:%M:%SZ")

result = fetch_workflow_logs_flow(
    created_at_after=one_hour_ago,
    created_at_before=now,
    output_format="csv",
    fetch_all=False,  # åªè·å–ä¸€é¡µæµ‹è¯•
    limit=5,
)
print("é…ç½®æ­£ç¡®ï¼")
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

1. **ç¼–è¾‘éƒ¨ç½²æ–‡ä»¶ï¼Œé…ç½®åº”ç”¨å‚æ•°**
   ```bash
   vim deployments/daily_report.py
   # ä¿®æ”¹ parameters ä¸­çš„ api_token å’Œ app_id
   ```

2. **ï¼ˆå¯é€‰ï¼‰åˆ›å»º `.env` æ–‡ä»¶ï¼Œé…ç½®é€šç”¨å‚æ•°**
   ```bash
   cp .env.example .env
   vim .env
   # è‡³å°‘å¡«å†™ DIFY_BASE_URL
   ```

3. **å¯åŠ¨å®šæ—¶ä»»åŠ¡**
   ```bash
   uv run python deployments/daily_report.py
   ```

**é‡è¦**ï¼š`api_token` å’Œ `app_id` å¿…é¡»åœ¨éƒ¨ç½²æ–‡ä»¶ä¸­é…ç½®ï¼Œæ¯ä¸ªåº”ç”¨ä½¿ç”¨ä¸åŒçš„å€¼ï¼
