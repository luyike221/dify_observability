# æ”¹é€ å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ç›®å½•ç»“æ„åˆ›å»º
- âœ… åˆ›å»ºäº†å®Œæ•´çš„æ¨¡å—åŒ–ç›®å½•ç»“æ„
- âœ… æ‰€æœ‰å¿…è¦çš„ `__init__.py` æ–‡ä»¶å·²åˆ›å»º

### 2. æ ¸å¿ƒæ¨¡å—å®ç°
- âœ… `src/core/exceptions.py` - è‡ªå®šä¹‰å¼‚å¸¸ç±»
- âœ… `src/core/config.py` - é…ç½®ç®¡ç†ï¼ˆæ”¯æŒç¯å¢ƒå˜é‡ï¼‰
- âœ… `src/core/logger.py` - ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ

### 3. æœåŠ¡å±‚å®ç°
- âœ… `src/services/fetcher.py` - å·¥ä½œæµæ—¥å¿—è·å–æœåŠ¡ï¼ˆé‡æ„è‡ªåŸè„šæœ¬ï¼‰
- âœ… `src/services/reporter.py` - æŠ¥å‘Šç”ŸæˆæœåŠ¡ï¼ˆCSV/Markdown/JSONï¼‰
- âœ… `src/services/storage.py` - å­˜å‚¨æœåŠ¡æŠ½è±¡ï¼ˆæ”¯æŒæœ¬åœ°/OSS/S3ï¼‰
- âœ… `src/services/notifier.py` - é€šçŸ¥æœåŠ¡ï¼ˆé‚®ä»¶/é’‰é’‰ï¼‰

### 4. å·¥å…·å‡½æ•°
- âœ… `src/utils/retry.py` - é‡è¯•è£…é¥°å™¨
- âœ… `src/utils/validators.py` - å‚æ•°æ ¡éªŒå·¥å…·
- âœ… `src/utils/formatters.py` - æ ¼å¼åŒ–å·¥å…·ï¼ˆæ—¶é—´æˆ³ã€JSONï¼‰

### 5. Prefect Flow å’Œ Task
- âœ… `src/flows/workflow_log_flow.py` - ä¸» Flow
- âœ… `src/flows/tasks/fetch_task.py` - è·å–æ—¥å¿— Task
- âœ… `src/flows/tasks/enrich_task.py` - ä¸°å¯Œè¯¦æƒ… Task
- âœ… `src/flows/tasks/report_task.py` - ç”ŸæˆæŠ¥å‘Š Task

### 6. Deployment é…ç½®
- âœ… `deployments/daily_report.py` - æ¯æ—¥æŠ¥å‘Š Deployment
- âœ… `deployments/weekly_report.py` - æ¯å‘¨æŠ¥å‘Š Deployment

### 7. é…ç½®å’Œæ–‡æ¡£
- âœ… `requirements.txt` - Python ä¾èµ–æ¸…å•
- âœ… `.env.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿
- âœ… `README.md` - ä½¿ç”¨æ–‡æ¡£
- âœ… `è¿ç§»æŒ‡å—.md` - è¿ç§»æŒ‡å—
- âœ… `scripts/setup_prefect.sh` - Prefect åˆå§‹åŒ–è„šæœ¬

## ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„

```
01-difyè¿ç»´ç›‘æ§/
â”œâ”€â”€ src/                          # æºä»£ç 
â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ exceptions.py        # å¼‚å¸¸ç±»
â”‚   â”‚   â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ logger.py            # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ services/                # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ fetcher.py           # æ—¥å¿—è·å–æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ reporter.py          # æŠ¥å‘Šç”ŸæˆæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ storage.py           # å­˜å‚¨æœåŠ¡
â”‚   â”‚   â””â”€â”€ notifier.py          # é€šçŸ¥æœåŠ¡
â”‚   â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ retry.py             # é‡è¯•è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ validators.py        # å‚æ•°æ ¡éªŒ
â”‚   â”‚   â””â”€â”€ formatters.py        # æ ¼å¼åŒ–å·¥å…·
â”‚   â””â”€â”€ flows/                   # Prefect Flow
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ workflow_log_flow.py  # ä¸» Flow
â”‚       â””â”€â”€ tasks/               # Task æ¨¡å—
â”‚           â”œâ”€â”€ __init__.py
â”‚           â”œâ”€â”€ fetch_task.py    # è·å–æ—¥å¿— Task
â”‚           â”œâ”€â”€ enrich_task.py   # ä¸°å¯Œè¯¦æƒ… Task
â”‚           â””â”€â”€ report_task.py   # ç”ŸæˆæŠ¥å‘Š Task
â”œâ”€â”€ deployments/                 # Deployment é…ç½®
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ daily_report.py          # æ¯æ—¥æŠ¥å‘Š
â”‚   â””â”€â”€ weekly_report.py         # æ¯å‘¨æŠ¥å‘Š
â”œâ”€â”€ scripts/                     # éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ setup_prefect.sh         # Prefect åˆå§‹åŒ–
â”œâ”€â”€ tests/                       # æµ‹è¯•æ¨¡å—
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ outputs/                     # è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ logs/                    # æ—¥å¿—æ–‡ä»¶
â”‚   â”œâ”€â”€ reports/                 # ç”Ÿæˆçš„æŠ¥å‘Š
â”‚   â””â”€â”€ data/                    # åŸå§‹æ•°æ®å¤‡ä»½
â”œâ”€â”€ requirements.txt             # Python ä¾èµ–
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ README.md                    # ä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ è¿ç§»æŒ‡å—.md                  # è¿ç§»æŒ‡å—
â”œâ”€â”€ æ”¹é€ æ–¹æ¡ˆ.md                  # æ”¹é€ æ–¹æ¡ˆ
â””â”€â”€ fetch_workflow_logs.py       # åŸè„šæœ¬ï¼ˆä¿ç•™ï¼Œå‘åå…¼å®¹ï¼‰
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æ¨¡å—åŒ–è®¾è®¡
- ä»£ç æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼ˆæ ¸å¿ƒ/æœåŠ¡/å·¥å…·/æµç¨‹ï¼‰

### 2. é…ç½®ç®¡ç†
- æ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼ˆ`.env` æ–‡ä»¶ï¼‰
- Pydantic éªŒè¯å’Œç±»å‹æ£€æŸ¥
- å¤šç¯å¢ƒæ”¯æŒï¼ˆdev/staging/prodï¼‰

### 3. æ—¥å¿—ç³»ç»Ÿ
- ç»“æ„åŒ–æ—¥å¿—ï¼ˆloguruï¼‰
- æ—¥å¿—æ–‡ä»¶è½®è½¬å’Œå‹ç¼©
- é›†æˆ Prefect æ—¥å¿—ç³»ç»Ÿ

### 4. é”™è¯¯å¤„ç†
- è‡ªå®šä¹‰å¼‚å¸¸ç±»
- é‡è¯•æœºåˆ¶ï¼ˆtenacityï¼‰
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 5. Prefect é›†æˆ
- Flow å’Œ Task ç¼–æ’
- ä»»åŠ¡è°ƒåº¦å’Œç›‘æ§
- UI å¯è§†åŒ–

### 6. æ‰©å±•æ€§
- å­˜å‚¨æœåŠ¡æŠ½è±¡ï¼ˆæ”¯æŒå¤šç§åç«¯ï¼‰
- é€šçŸ¥æœåŠ¡æŠ½è±¡ï¼ˆæ”¯æŒå¤šç§æ¸ é“ï¼‰
- æ˜“äºæ·»åŠ æ–°åŠŸèƒ½

## ğŸ“ ä½¿ç”¨æ–¹å¼

### å¿«é€Ÿå¼€å§‹

1. **å®‰è£…ä¾èµ–**
   ```bash
   pip install -r requirements.txt
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   cp .env.example .env
   # ç¼–è¾‘ .env æ–‡ä»¶
   ```

3. **å¯åŠ¨ Prefect Server**
   ```bash
   prefect server start
   ```

4. **è®¾ç½® Prefect ç¯å¢ƒ**
   ```bash
   ./scripts/setup_prefect.sh
   ```

5. **å¯åŠ¨ Worker**
   ```bash
   prefect worker start --pool dify-workflow-pool
   ```

6. **éƒ¨ç½²ä»»åŠ¡**
   ```bash
   python deployments/daily_report.py
   ```

### ä½¿ç”¨ Flow

```python
from src.flows.workflow_log_flow import fetch_workflow_logs_flow

result = fetch_workflow_logs_flow(
    created_at_after="2024-01-01T00:00:00Z",
    created_at_before="2024-01-31T23:59:59Z",
    output_format="csv",
    with_details=True,
    with_node_executions=True,
)
```

### ä½¿ç”¨åŸè„šæœ¬ï¼ˆå‘åå…¼å®¹ï¼‰

```bash
python fetch_workflow_logs.py \
  --api-token app-xxx \
  --base-url http://localhost \
  --with-details \
  --output-csv-dir ./outputs
```

## ğŸ”„ å‘åå…¼å®¹

âœ… **å®Œå…¨å‘åå…¼å®¹**ï¼š
- åŸè„šæœ¬ `fetch_workflow_logs.py` ä¿ç•™
- æ‰€æœ‰å‘½ä»¤è¡Œå‚æ•°åŠŸèƒ½ä¿æŒä¸å˜
- è¾“å‡ºæ ¼å¼ä¿æŒä¸€è‡´

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

| é¡¹ç›® | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|------|--------|--------|
| ä»£ç ç»„ç»‡ | å•ä½“è„šæœ¬ï¼ˆ1300+ è¡Œï¼‰ | æ¨¡å—åŒ–ï¼ˆå¤šä¸ªæ–‡ä»¶ï¼‰ |
| é…ç½®ç®¡ç† | å‘½ä»¤è¡Œå‚æ•° | ç¯å¢ƒå˜é‡ + é…ç½®æ–‡ä»¶ |
| ä»»åŠ¡è°ƒåº¦ | æ‰‹åŠ¨æ‰§è¡Œ/cron | Prefect è°ƒåº¦ |
| ç›‘æ§ | æ—  | Prefect UI |
| æ—¥å¿— | print è¾“å‡º | ç»“æ„åŒ–æ—¥å¿— |
| é”™è¯¯å¤„ç† | åŸºç¡€ | å®Œå–„çš„é‡è¯•å’Œé”™è¯¯å¤„ç† |
| é€šçŸ¥ | æ—  | é‚®ä»¶/é’‰é’‰é€šçŸ¥ |
| å­˜å‚¨ | æœ¬åœ°æ–‡ä»¶ | æŠ½è±¡æ¥å£ï¼ˆæ”¯æŒå¤šç§åç«¯ï¼‰ |

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•æ–°ç³»ç»Ÿ**
   - è¿è¡Œæµ‹è¯•ç”¨ä¾‹
   - éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

2. **é…ç½®ç”Ÿäº§ç¯å¢ƒ**
   - è®¾ç½®ç¯å¢ƒå˜é‡
   - é…ç½®é€šçŸ¥æ¸ é“
   - è®¾ç½®å­˜å‚¨åç«¯ï¼ˆå¦‚éœ€è¦ï¼‰

3. **éƒ¨ç½²åˆ°ç”Ÿäº§**
   - ä½¿ç”¨ Docker Compose éƒ¨ç½² Prefect Server
   - é…ç½® Worker è¿›ç¨‹
   - éƒ¨ç½²å®šæ—¶ä»»åŠ¡

4. **ç›‘æ§å’Œç»´æŠ¤**
   - å®šæœŸæŸ¥çœ‹ Prefect UI
   - æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
   - ç›‘æ§å­˜å‚¨ç©ºé—´

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `README.md` - è¯¦ç»†ä½¿ç”¨è¯´æ˜
- `è¿ç§»æŒ‡å—.md` - ä»æ—§è„šæœ¬è¿ç§»çš„æ­¥éª¤
- `æ”¹é€ æ–¹æ¡ˆ.md` - æ¶æ„è®¾è®¡æ–‡æ¡£

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Prefect ä¾èµ–**: éœ€è¦å…ˆå®‰è£… Prefect æ‰èƒ½ä½¿ç”¨æ–°åŠŸèƒ½
2. **ç¯å¢ƒå˜é‡**: ç¡®ä¿ `.env` æ–‡ä»¶é…ç½®æ­£ç¡®
3. **å‘åå…¼å®¹**: åŸè„šæœ¬ä»ç„¶å¯ç”¨ï¼Œå¯ä»¥é€æ­¥è¿ç§»
4. **æµ‹è¯•**: å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åå†éƒ¨ç½²åˆ°ç”Ÿäº§

## âœ¨ æ€»ç»“

æ”¹é€ å·²å®Œæˆï¼æ–°ç³»ç»Ÿæä¾›äº†ï¼š
- âœ… æ›´å¥½çš„ä»£ç ç»„ç»‡å’Œå¯ç»´æŠ¤æ€§
- âœ… å®Œå–„çš„é…ç½®ç®¡ç†å’Œæ—¥å¿—ç³»ç»Ÿ
- âœ… Prefect ä»»åŠ¡è°ƒåº¦å’Œç›‘æ§
- âœ… æ‰©å±•æ€§å’Œçµæ´»æ€§
- âœ… å®Œå…¨å‘åå…¼å®¹

å¯ä»¥å¼€å§‹ä½¿ç”¨æ–°ç³»ç»Ÿäº†ï¼ğŸ‰
